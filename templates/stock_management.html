<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Management</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f3f4f6;
      }
      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      header h1 {
        font-size: 20px;
        margin: 0;
      }
      header a {
        font-size: 13px;
        color: #2563eb;
        text-decoration: none;
      }
      header a:hover {
        text-decoration: underline;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin-bottom: 16px;
        padding: 8px 10px;
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      }
      .controls label {
        font-size: 13px;
        color: #374151;
      }
      .controls input {
        padding: 4px 8px;
        font-size: 13px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        min-width: 180px;
      }
      .btn {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
      }
      .btn-primary {
        background: #2563eb;
        color: #fff;
      }
      .btn-primary:disabled {
        background: #9ca3af;
        cursor: default;
      }
      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
      }
      .status {
        font-size: 12px;
        color: #374151;
        margin-top: 4px;
        min-height: 16px;
      }
      .status.error {
        color: #b91c1c;
      }
      .filters {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
        padding: 6px 10px;
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        font-size: 12px;
      }
      .filters-line {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .filters-label {
        font-size: 13px;
        color: #374151;
        margin-right: 4px;
      }
      .filter-btn.active {
        background: #2563eb;
        color: #fff;
      }
      .filters input[type="search"] {
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        min-width: 160px;
      }
      .filters .inline-label {
        font-size: 12px;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .bill-section {
        margin-bottom: 16px;
        padding: 8px 10px;
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        font-size: 12px;
      }
      .bill-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .bill-section-header h2 {
        font-size: 14px;
        margin: 0;
      }
      .bill-actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .bill-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 4px;
      }
      .bill-table th,
      .bill-table td {
        border-bottom: 1px solid #e5e7eb;
        padding: 4px 2px;
        font-size: 11px;
        text-align: left;
      }
      .bill-table input {
        width: 100%;
        box-sizing: border-box;
        padding: 2px 4px;
        font-size: 11px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
      }
      .bill-summary {
        margin-top: 4px;
        font-size: 11px;
        color: #4b5563;
      }
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 12px;
        align-items: stretch;
      }
      .product-card {
        background: #fff;
        border-radius: 8px;
        padding: 10px 10px 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .product-title {
        font-size: 14px;
        font-weight: 600;
        color: #111827;
      }
      .product-sub {
        font-size: 12px;
        color: #6b7280;
      }
      .field-row {
        display: flex;
        gap: 6px;
        align-items: center;
        font-size: 12px;
      }
      .field-row label {
        min-width: 60px;
        color: #374151;
      }
      .field-row input {
        flex: 1;
        padding: 3px 6px;
        font-size: 12px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
      }
      .badge {
        display: inline-block;
        padding: 1px 6px;
        border-radius: 999px;
        font-size: 10px;
        background: #e5e7eb;
        color: #374151;
      }
      .batches {
        margin-top: 4px;
        border-top: 1px solid #e5e7eb;
        padding-top: 4px;
      }
      .batches-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
        color: #4b5563;
        margin-bottom: 2px;
      }
      .batch-row {
        display: grid;
        grid-template-columns: 0.9fr 0.7fr 1.1fr;
        gap: 4px;
        align-items: center;
        margin-bottom: 3px;
      }
      .batch-row span {
        font-size: 11px;
        color: #6b7280;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .batch-row input {
        padding: 2px 4px;
        font-size: 11px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
      }
      .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 4px;
        gap: 6px;
      }
      .stock-info {
        font-size: 11px;
        color: #4b5563;
      }
      .save-status {
        font-size: 11px;
        color: #059669;
        min-height: 14px;
      }
      .save-status.error {
        color: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>Stock Management</h1>
        <a href="/test">&larr; Back to Test Chat</a>
      </header>

      <section class="controls">
        <label for="phoneInput">Shop phone (WhatsApp number):</label>
        <input id="phoneInput" type="text" placeholder="e.g. +91XXXXXXXXXX" />
        <button id="loadBtn" class="btn btn-primary" onclick="loadProducts()">
          Load products
        </button>
        <span id="globalStatus" class="status"></span>
      </section>

      <section class="filters">
        <div class="filters-line">
          <span class="filters-label">Quick filters:</span>
          <button
            class="btn btn-secondary filter-btn active"
            data-filter="all"
            onclick="setFilter('all', this)"
          >
            All
          </button>
          <button
            class="btn btn-secondary filter-btn"
            data-filter="rice"
            onclick="setFilter('rice', this)"
          >
            Rice
          </button>
          <button
            class="btn btn-secondary filter-btn"
            data-filter="flour"
            onclick="setFilter('flour', this)"
          >
            Flour
          </button>
          <button
            class="btn btn-secondary filter-btn"
            data-filter="oil"
            onclick="setFilter('oil', this)"
          >
            Oil
          </button>
          <button
            class="btn btn-secondary filter-btn"
            data-filter="maggi"
            onclick="setFilter('maggi', this)"
          >
            Maggi
          </button>
        </div>
        <div class="filters-line">
          <label class="inline-label" for="searchInput"> Search: </label>
          <input
            id="searchInput"
            type="search"
            placeholder="name, brand or barcode"
            oninput="onSearchChange()"
          />
          <label class="inline-label">
            <input
              type="checkbox"
              id="hideZeroStock"
              onchange="onHideZeroToggle()"
            />
            Hide zero stock
          </label>
        </div>
      </section>

      <section class="bill-section">
        <div class="bill-section-header">
          <h2>Bill entry (add stock)</h2>
          <div class="bill-actions">
            <button
              class="btn btn-secondary"
              type="button"
              onclick="addBillRow()"
            >
              + Add line
            </button>
            <button
              class="btn btn-secondary"
              type="button"
              onclick="clearBillRows()"
            >
              Clear
            </button>
            <button
              class="btn btn-primary"
              type="button"
              onclick="submitBill()"
            >
              Save bill
            </button>
          </div>
        </div>
        <p style="margin: 0 0 4px 0; font-size: 11px; color: #6b7280">
          Fast way to add today's purchase stock. Choose product, enter quantity
          (and optional cost per unit).
        </p>
        <table class="bill-table">
          <thead>
            <tr>
              <th style="width: 45%">Product (name / brand / barcode)</th>
              <th style="width: 15%">Qty</th>
              <th style="width: 20%">Cost / unit (optional)</th>
              <th style="width: 15%">Notes</th>
              <th style="width: 5%"></th>
            </tr>
          </thead>
          <tbody id="billBody"></tbody>
        </table>
        <datalist id="productOptions"></datalist>
        <div id="billSummary" class="bill-summary"></div>
      </section>

      <div id="productsGrid" class="products-grid"></div>
    </div>

    <script>
      let currentPhone = "";
      let allProducts = [];
      let currentFilter = "all";
      let currentSearch = "";

      function renderProductOptions() {
        const datalist = document.getElementById("productOptions");
        if (!datalist) return;
        datalist.innerHTML = "";
        if (!Array.isArray(allProducts)) return;
        allProducts.forEach((p) => {
          if (!p) return;
          const opt = document.createElement("option");
          const name = p.name || "";
          const brand = p.brand ? ` (${p.brand})` : "";
          const unit = p.unit ? ` [${p.unit}]` : "";
          opt.value = `${name}${brand}${unit}`;
          if (p.barcode) {
            opt.label = `${opt.value} — ${p.barcode}`;
          }
          if (p.product_id) {
            opt.setAttribute("data-product-id", p.product_id);
          }
          datalist.appendChild(opt);
        });
      }

      function onBillProductInput(inputEl) {
        const datalist = document.getElementById("productOptions");
        if (!datalist || !inputEl) return;
        const val = inputEl.value || "";
        let matchedId = "";
        for (const opt of datalist.options) {
          if (opt.value === val) {
            matchedId = opt.getAttribute("data-product-id") || "";
            break;
          }
        }
        if (matchedId) {
          inputEl.dataset.productId = matchedId;
        } else {
          delete inputEl.dataset.productId;
        }
      }

      function addBillRow() {
        const tbody = document.getElementById("billBody");
        if (!tbody) return;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <input
              type="text"
              list="productOptions"
              placeholder="Start typing name or brand"
              oninput="onBillProductInput(this)"
            />
          </td>
          <td>
            <input type="number" min="0" step="0.01" placeholder="0" />
          </td>
          <td>
            <input
              type="number"
              min="0"
              step="0.01"
              placeholder="Rs/unit"
            />
          </td>
          <td>
            <input type="text" placeholder="note" />
          </td>
          <td>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="this.closest('tr').remove();"
            >
              X
            </button>
          </td>
        `;
        tbody.appendChild(row);
      }

      function clearBillRows() {
        const tbody = document.getElementById("billBody");
        if (tbody) tbody.innerHTML = "";
        const summary = document.getElementById("billSummary");
        if (summary) summary.textContent = "";
      }

      async function submitBill() {
        if (!currentPhone) {
          setGlobalStatus("First enter shop phone and load products.", true);
          return;
        }
        const tbody = document.getElementById("billBody");
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll("tr"));
        if (!rows.length) {
          setGlobalStatus("Add at least one line in bill.", true);
          return;
        }
        const items = [];
        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          if (cells.length < 4) return;
          const productInput = cells[0].querySelector("input");
          const qtyInput = cells[1].querySelector("input");
          const costInput = cells[2].querySelector("input");
          const noteInput = cells[3].querySelector("input");

          const name = (productInput && productInput.value) || "";
          const qtyStr = (qtyInput && qtyInput.value) || "";
          const costStr = (costInput && costInput.value) || "";
          const note = (noteInput && noteInput.value) || "";

          const quantity = parseFloat(qtyStr);
          if (!name.trim() || !quantity || isNaN(quantity) || quantity <= 0) {
            return;
          }

          const item = {
            name: name.trim(),
            quantity,
          };

          const productId = productInput && productInput.dataset.productId;
          if (productId) {
            item.product_id = productId;
          }

          const cp = parseFloat(costStr);
          if (!isNaN(cp) && cp >= 0) {
            item.cost_price = cp;
          }

          if (note.trim()) {
            item.note = note.trim();
          }

          items.push(item);
        });

        if (!items.length) {
          setGlobalStatus(
            "Please fill product and quantity for at least one bill line.",
            true
          );
          return;
        }

        const summaryEl = document.getElementById("billSummary");
        if (summaryEl) summaryEl.textContent = "Saving bill...";

        try {
          const resp = await fetch("/api/stock/bill", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone: currentPhone, items }),
          });
          const data = await resp.json();
          if (!resp.ok || !data.success) {
            throw new Error(data.message || "Failed to save bill");
          }

          let totalQty = 0;
          const returnedItems = Array.isArray(data.items) ? data.items : [];
          returnedItems.forEach((it) => {
            const q = parseFloat(it.quantity);
            if (!isNaN(q)) totalQty += q;
          });

          if (summaryEl) {
            summaryEl.textContent = `Saved bill: ${returnedItems.length} lines, total quantity ${totalQty}.`;
          }

          setGlobalStatus("Bill saved and stock updated.", false);
          // Refresh products so stock cards show latest quantities
          loadProducts();
        } catch (err) {
          console.error(err);
          if (summaryEl) {
            summaryEl.textContent = err.message || "Error while saving bill.";
          }
          setGlobalStatus("Error while saving bill.", true);
        }
      }
      let hideZeroStock = false;

      function setGlobalStatus(text, isError) {
        const el = document.getElementById("globalStatus");
        el.textContent = text || "";
        el.classList.toggle("error", !!isError);
      }

      async function loadProducts() {
        const phoneInput = document.getElementById("phoneInput");
        const phone = (phoneInput.value || "").trim();
        if (!phone) {
          setGlobalStatus("Please enter shop phone number.", true);
          return;
        }
        const btn = document.getElementById("loadBtn");
        btn.disabled = true;
        setGlobalStatus("Loading products...", false);
        try {
          const resp = await fetch(
            `/api/stock/products?phone=${encodeURIComponent(phone)}`
          );
          const data = await resp.json();
          if (!resp.ok || !data.success) {
            throw new Error(data.message || "Failed to load products");
          }
          currentPhone = phone;
          allProducts = data.products || [];
          renderProductOptions();
          applyFiltersAndRender();
          setGlobalStatus(`Loaded ${allProducts.length} products.`, false);
        } catch (err) {
          console.error(err);
          setGlobalStatus(err.message || "Error while loading products.", true);
        } finally {
          btn.disabled = false;
        }
      }

      function setFilter(filter, btnEl) {
        currentFilter = filter || "all";
        const buttons = document.querySelectorAll(".filter-btn");
        buttons.forEach((b) => b.classList.remove("active"));
        if (btnEl) {
          btnEl.classList.add("active");
        }
        applyFiltersAndRender();
      }

      function onSearchChange() {
        const input = document.getElementById("searchInput");
        currentSearch = (input && input.value ? input.value : "").toLowerCase();
        applyFiltersAndRender();
      }

      function onHideZeroToggle() {
        const checkbox = document.getElementById("hideZeroStock");
        hideZeroStock = !!(checkbox && checkbox.checked);
        applyFiltersAndRender();
      }

      function applyFiltersAndRender() {
        if (!Array.isArray(allProducts)) {
          allProducts = [];
        }
        let filtered = allProducts.slice();
        const f = (currentFilter || "all").toLowerCase();
        const search = (currentSearch || "").trim();

        filtered = filtered.filter((p) => {
          if (!p) return false;

          // Category quick filters
          if (f !== "all") {
            const name = (p.name || "").toLowerCase();
            const brand = (p.brand || "").toLowerCase();
            const normalized = (p.normalized_name || "").toLowerCase();
            const text = `${name} ${brand} ${normalized}`;
            let match = false;

            if (f === "rice") {
              match =
                text.includes("rice") ||
                text.includes("chawal") ||
                text.includes("basmati");
            } else if (f === "flour") {
              match =
                text.includes("flour") ||
                text.includes("atta") ||
                text.includes("aata") ||
                text.includes("maida") ||
                text.includes("suji");
            } else if (f === "oil") {
              match =
                text.includes("oil") ||
                text.includes("tel") ||
                text.includes("ghee") ||
                text.includes("refined");
            } else if (f === "maggi") {
              match =
                text.includes("maggi") ||
                text.includes("noodle") ||
                text.includes("noodles");
            }

            if (!match) {
              return false;
            }
          }

          // Text search (name, brand, normalized name, barcode)
          if (search) {
            const blob = `${p.name || ""} ${p.brand || ""} ${
              p.normalized_name || ""
            } ${p.barcode || ""}`.toLowerCase();
            if (!blob.includes(search)) {
              return false;
            }
          }

          // Hide zero-stock items
          if (hideZeroStock) {
            const stock =
              typeof p.current_stock === "number" ? p.current_stock : null;
            if (stock === null || stock === 0) {
              return false;
            }
          }

          return true;
        });

        renderProducts(filtered);
      }

      function renderProducts(products) {
        const container = document.getElementById("productsGrid");
        container.innerHTML = "";
        if (!products || products.length === 0) {
          container.textContent = "No products found for this shop.";
          return;
        }
        products.forEach((p) => {
          const card = document.createElement("div");
          card.className = "product-card";
          card.dataset.productId = p.product_id;

          const title = document.createElement("div");
          title.className = "product-title";
          title.textContent = p.name || "(no name)";
          card.appendChild(title);

          const sub = document.createElement("div");
          sub.className = "product-sub";
          const brand = p.brand ? ` · ${p.brand}` : "";
          const unit = p.unit || "pieces";
          sub.textContent = `${unit}${brand}`;
          card.appendChild(sub);

          const codeRow = document.createElement("div");
          codeRow.className = "field-row";
          const codeLabel = document.createElement("label");
          codeLabel.textContent = "Barcode";
          const codeInput = document.createElement("input");
          codeInput.type = "text";
          codeInput.value = p.barcode || "";
          codeInput.className = "barcode-input";
          codeRow.appendChild(codeLabel);
          codeRow.appendChild(codeInput);
          card.appendChild(codeRow);

          const batchesWrapper = document.createElement("div");
          batchesWrapper.className = "batches";
          const header = document.createElement("div");
          header.className = "batches-header";
          header.innerHTML = `<span>Batches (qty + expiry)</span>`;
          batchesWrapper.appendChild(header);

          const batches =
            p.batches && typeof p.batches === "object" ? p.batches : {};
          const keys = Object.keys(batches);
          if (keys.length === 0) {
            const emptyRow = document.createElement("div");
            emptyRow.style.fontSize = "11px";
            emptyRow.style.color = "#9ca3af";
            emptyRow.textContent = "No batch info saved yet.";
            batchesWrapper.appendChild(emptyRow);
          } else {
            keys.forEach((batchId) => {
              const b = batches[batchId] || {};
              const row = document.createElement("div");
              row.className = "batch-row";
              row.dataset.batchId = batchId;

              const idSpan = document.createElement("span");
              idSpan.textContent = batchId;
              row.appendChild(idSpan);

              const qtyInput = document.createElement("input");
              qtyInput.type = "number";
              qtyInput.step = "0.01";
              qtyInput.value =
                b.qty != null ? b.qty : b.quantity != null ? b.quantity : "";
              qtyInput.className = "batch-qty";
              row.appendChild(qtyInput);

              const expiryInput = document.createElement("input");
              expiryInput.type = "date";
              const rawExpiry = b.expiry_date || b.expiry || "";
              expiryInput.value = rawExpiry
                ? String(rawExpiry).slice(0, 10)
                : "";
              expiryInput.className = "batch-expiry";
              row.appendChild(expiryInput);

              batchesWrapper.appendChild(row);
            });
          }
          card.appendChild(batchesWrapper);

          const footer = document.createElement("div");
          footer.className = "card-footer";
          const stockInfo = document.createElement("div");
          stockInfo.className = "stock-info";
          const currentStock =
            typeof p.current_stock === "number" ? p.current_stock : "?";
          stockInfo.textContent = `Total stock: ${currentStock} ${
            p.unit || ""
          }`;
          footer.appendChild(stockInfo);

          const saveArea = document.createElement("div");
          saveArea.style.display = "flex";
          saveArea.style.flexDirection = "column";
          saveArea.style.alignItems = "flex-end";
          const saveBtn = document.createElement("button");
          saveBtn.textContent = "Save";
          saveBtn.className = "btn btn-secondary";
          saveBtn.onclick = () => saveProduct(card, p.product_id);
          const saveStatus = document.createElement("div");
          saveStatus.className = "save-status";
          saveArea.appendChild(saveBtn);
          saveArea.appendChild(saveStatus);

          footer.appendChild(saveArea);
          card.appendChild(footer);

          container.appendChild(card);
        });
      }

      async function saveProduct(cardEl, productId) {
        const phone = currentPhone;
        if (!phone) {
          setGlobalStatus("Please load products with a phone first.", true);
          return;
        }
        const statusEl = cardEl.querySelector(".save-status");
        statusEl.textContent = "Saving...";
        statusEl.classList.remove("error");
        const barcode = (
          cardEl.querySelector(".barcode-input").value || ""
        ).trim();

        const batchRows = cardEl.querySelectorAll(".batch-row");
        const batches = {};
        batchRows.forEach((row) => {
          const id = row.dataset.batchId;
          if (!id) return;
          const qtyStr = (row.querySelector(".batch-qty").value || "").trim();
          const expiryStr = row.querySelector(".batch-expiry").value || "";
          const b = {};
          if (qtyStr !== "") {
            const q = parseFloat(qtyStr);
            if (!Number.isNaN(q)) b.qty = q;
          }
          if (expiryStr) {
            b.expiry_date = expiryStr;
          }
          batches[id] = b;
        });

        const payload = { barcode, batches };
        try {
          const resp = await fetch(
            `/api/stock/products/${encodeURIComponent(
              productId
            )}?phone=${encodeURIComponent(phone)}`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            }
          );
          const data = await resp.json();
          if (!resp.ok || !data.success) {
            throw new Error(data.message || "Failed to save");
          }
          statusEl.textContent = "Saved";
          statusEl.classList.remove("error");
          setGlobalStatus("Changes saved.", false);
        } catch (err) {
          console.error(err);
          statusEl.textContent = err.message || "Error";
          statusEl.classList.add("error");
          setGlobalStatus("Error while saving changes.", true);
        }
      }
    </script>
  </body>
</html>
